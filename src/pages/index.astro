---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/base-layout.astro';
import ReviewCard from '../components/review-card.astro';
import { getSiteUrl, sortByDate, sortByScore } from '../utils/review-helpers';

const allReviews = await getCollection('reviews');
const allArtists = await getCollection('artists');
const allExaminers = await getCollection('examiners');

const artistMap = Object.fromEntries(
  allArtists.map(artist => [artist.id, artist.data.name])
);

const reviewsWithArtist = allReviews.map(review => ({
  ...review,
  artistName: artistMap[review.data.artist_id] || review.data.artist_id
}));

const sortedByDate = sortByDate(reviewsWithArtist);

const sortedByScore = sortByScore(reviewsWithArtist);

const latestReviews = sortedByDate.slice(0, 6);
const topRated = sortedByScore.slice(0, 5);
const bottomRated = sortedByScore.slice(-5).reverse();

const stats = {
  reviews: allReviews.length,
  artists: allArtists.length,
  examiners: allExaminers.length,
};

// Schema.org CollectionPage
const siteUrl = getSiteUrl();
const collectionSchema = {
  '@context': 'https://schema.org',
  '@type': 'CollectionPage',
  name: 'Song Autopsy - AI-Powered Lyrical Analysis',
  description: 'Surgical analysis of song lyrics. Cold. Clinical. Precise.',
  url: siteUrl,
  mainEntity: {
    '@type': 'ItemList',
    numberOfItems: latestReviews.length,
    itemListElement: latestReviews.map((review, index) => ({
      '@type': 'ListItem',
      position: index + 1,
      item: {
        '@type': 'Review',
        itemReviewed: {
          '@type': 'MusicRecording',
          name: review.data.song,
          byArtist: {
            '@type': 'MusicGroup',
            name: review.artistName,
          }
        }
      }
    }))
  }
}
---

<BaseLayout 
  stats={stats}
  schema={collectionSchema}
>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    
    <section class="mb-20">
      <h1 class="text-5xl sm:text-6xl font-bold mb-6 bg-gradient-to-r from-zinc-100 to-zinc-400 bg-clip-text text-transparent">
        Song Autopsy
      </h1>
      <p class="text-lg text-zinc-400 max-w-3xl leading-relaxed">
        Surgical analysis of song lyrics. Cold. Clinical. Precise. Every dissection follows the same criteria,
        with only variations in forensic depth.
      </p>
    </section>

    <section class="mb-20">
      <h2 class="text-3xl font-bold mb-8 text-zinc-100">Latest Reviews</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {latestReviews.map(review => {
          const [artistSlug, songSlug] = review.id.split('/')
          return (
            <ReviewCard
              song={review.data.song}
              artistName={review.artistName}
              score={review.data.final_score}
              snippet={review.data.texts.emotional_impact.substring(0, 150) + '...'}
              href={`/${artistSlug}/${songSlug}`}
            />
          )
        })}
      </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-20">
      
      <div>
        <h2 class="text-2xl font-bold mb-6 text-emerald-400 flex items-center gap-2">
          <span>↑</span> Top Rated
        </h2>
        <div class="space-y-4">
          {topRated.map((review, i) => {
            const [artistSlug, songSlug] = review.id.split('/')
            return (
              <a href={`/${artistSlug}/${songSlug}`} class="block group">
                <div class="flex items-start gap-3 bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                  <span class="text-2xl font-bold text-zinc-600">{i + 1}</span>
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-zinc-100 group-hover:text-white transition-colors truncate">
                      {review.data.song}
                    </h3>
                    <p class="text-sm text-zinc-500">{review.artistName}</p>
                  </div>
                  <span class="text-lg font-bold text-emerald-400 shrink-0">
                    {review.data.final_score.toFixed(1)}
                  </span>
                </div>
              </a>
            )
          })}
        </div>
      </div>

      <div>
        <h2 class="text-2xl font-bold mb-6 text-red-400 flex items-center gap-2">
          <span>↓</span> Bottom Rated
        </h2>
        <div class="space-y-4">
          {bottomRated.map((review, i) => {
            const [artistSlug, songSlug] = review.id.split('/')
            return (
              <a href={`/${artistSlug}/${songSlug}`} class="block group">
                <div class="flex items-start gap-3 bg-zinc-900 border border-zinc-800 rounded-lg p-4 hover:border-zinc-700 transition-colors">
                  <span class="text-2xl font-bold text-zinc-600">{i + 1}</span>
                  <div class="flex-1 min-w-0">
                    <h3 class="font-semibold text-zinc-100 group-hover:text-white transition-colors truncate">
                      {review.data.song}
                    </h3>
                    <p class="text-sm text-zinc-500">{review.artistName}</p>
                  </div>
                  <span class="text-lg font-bold text-red-400 shrink-0">
                    {review.data.final_score.toFixed(1)}
                  </span>
                </div>
              </a>
            )
          })}
        </div>
      </div>

      <div class="flex flex-col">
        <h2 class="text-2xl font-bold mb-6 text-zinc-400">Request Analysis</h2>
        <div class="flex-1 bg-zinc-900 border border-zinc-800 rounded-lg p-8 flex flex-col items-center justify-center text-center">
          <svg class="w-16 h-16 text-zinc-700 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          <h3 class="text-xl font-semibold text-zinc-300 mb-2">Coming Soon</h3>
          <p class="text-sm text-zinc-500">
            Request lyrics analysis for your favorite songs
          </p>
        </div>
      </div>

    </section>

  </main>
</BaseLayout>
