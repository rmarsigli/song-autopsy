---
import { getCollection, getEntry, type CollectionEntry } from 'astro:content'
import BaseLayout from '../../../layouts/base-layout.astro'
import Breadcrumb from '../../../components/breadcrumb.astro'
import SpotifyEmbed from '../../../components/SpotifyEmbed.astro'
import ReviewListItem from '../../../components/review-list-item.astro'
import { calculateAverageScore, sortByScore, getReviewSlugs } from '../../../utils/review-helpers'

export async function getStaticPaths() {
  const reviews = await getCollection('reviews')
  
  // Group reviews by artist + album
  const byArtistAlbum = reviews.reduce((acc, review) => {
    if (!review.data.album_id) return acc
    
    const [artistSlug] = review.id.split('/')
    const key = `${artistSlug}/${review.data.album_id}`
    
    if (!acc[key]) acc[key] = []
    acc[key].push(review)
    return acc
  }, {} as Record<string, CollectionEntry<'reviews'>[]>)
  
  return Object.entries(byArtistAlbum).map(([key, albumReviews]) => {
    const [artistSlug, albumId] = key.split('/')
    
    return {
      params: { artist: artistSlug, album: albumId },
      props: { albumReviews },
    }
  })
}

type Props = {
  albumReviews: CollectionEntry<'reviews'>[]
}

const { albumReviews } = Astro.props as Props
const firstReview = albumReviews[0]

const artist = await getEntry('artists', firstReview.data.artist_id)
const album = await getEntry('albums', `${firstReview.data.artist_id}/${firstReview.data.album_id}`)

if (!artist || !album) {
  throw new Error(`Missing artist or album data`)
}

// Sort by score (highest first)
const sortedReviews = sortByScore(albumReviews)

// Calculate stats
const totalReviews = albumReviews.length
const avgScore = calculateAverageScore(albumReviews)
---

<BaseLayout title={`${album.data.title} - ${artist.data.name}`}>
  <div class="mx-auto max-w-6xl px-4 py-12">
    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: artist.data.name, href: `/${firstReview.data.artist_id}` },
      { label: album.data.title }
    ]} />

    <!-- Album Header -->
    <div class="mb-12 border-b border-zinc-800 pb-8">
      <div class="flex flex-col md:flex-row gap-8">
        
        <!-- Cover Art & Spotify Embed -->
        <div class="w-full md:w-1/3 flex flex-col gap-6">
             {album.data.cover_image && (
               <img 
                 src={album.data.cover_image} 
                 alt={album.data.title} 
                 class="w-full rounded-lg shadow-2xl border border-zinc-800" 
                 width="300" 
                 height="300"
               />
             )}
             
             {album.data.spotify_id && (
               <div class="rounded-xl overflow-hidden shadow-lg border border-zinc-800">
                 <SpotifyEmbed type="album" id={album.data.spotify_id} />
               </div>
             )}
        </div>

        <!-- Album Info -->
        <div class="w-full md:w-2/3">
          <div class="mb-2 text-sm text-zinc-500">
            <a href={`/${firstReview.data.artist_id}`} class="hover:text-zinc-300 transition-colors uppercase tracking-wider font-medium">
              {artist.data.name}
            </a>
          </div>
          <h1 class="mb-6 text-5xl md:text-6xl font-bold tracking-tight text-white leading-tight">
            {album.data.title}
          </h1>
          
          <div class="flex flex-wrap gap-4 text-base text-zinc-400 mb-8">
            {album.data.year && (
              <div class="bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
                <span class="text-zinc-500 mr-2">Year</span>
                <span class="text-zinc-200 font-medium">{album.data.year}</span>
              </div>
            )}
            {album.data.genre && album.data.genre.length > 0 && (
              <div class="bg-zinc-900 px-3 py-1 rounded-full border border-zinc-800">
                <span class="text-zinc-500 mr-2">Genre</span>
                <span class="text-zinc-200 font-medium">{album.data.genre.join(', ')}</span>
              </div>
            )}
          </div>

          <div class="grid grid-cols-2 gap-4 max-w-sm">
            <div class="bg-zinc-900/50 p-4 rounded-lg border border-zinc-800">
              <span class="block text-3xl font-bold text-white mb-1">{totalReviews}</span>
              <span class="text-zinc-500 text-sm font-medium uppercase tracking-wide">Reviews Analyzing</span>
            </div>
            <div class="bg-zinc-900/50 p-4 rounded-lg border border-zinc-800">
              <span class={`block text-3xl font-bold ${parseFloat(avgScore) >= 7 ? 'text-emerald-400' : parseFloat(avgScore) >= 5 ? 'text-yellow-400' : 'text-red-400'} mb-1`}>{avgScore}</span>
              <span class="text-zinc-500 text-sm font-medium uppercase tracking-wide">Avg Score</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Reviews List -->
    <div class="space-y-2">
      <h2 class="mb-6 text-2xl font-bold text-white">Tracks</h2>
      
      {sortedReviews.map((review) => {
        const { artist: artistSlug, song: songSlug } = getReviewSlugs(review.id)
        
        return (
          <ReviewListItem
            song={review.data.song}
            score={review.data.final_score}
            href={`/${artistSlug}/${songSlug}`}
          />
        )
      })}
    </div>
  </div>
</BaseLayout>
