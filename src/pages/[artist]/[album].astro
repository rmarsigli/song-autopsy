---
import { getCollection, getEntry, type CollectionEntry } from 'astro:content'
import BaseLayout from '../../layouts/base-layout.astro'
import Breadcrumb from '../../components/breadcrumb.astro'
import ReviewListItem from '../../components/review-list-item.astro'
import { calculateAverageScore, sortByScore, getReviewSlugs } from '../../utils/review-helpers'

export async function getStaticPaths() {
  const reviews = await getCollection('reviews')
  const albums = await getCollection('albums')
  
  // Group reviews by artist + album
  const byArtistAlbum = reviews.reduce((acc, review) => {
    if (!review.data.album_id) return acc
    
    const [artistSlug] = review.id.split('/')
    const key = `${artistSlug}/${review.data.album_id}`
    
    if (!acc[key]) acc[key] = []
    acc[key].push(review)
    return acc
  }, {} as Record<string, CollectionEntry<'reviews'>[]>)
  
  return Object.entries(byArtistAlbum).map(([key, albumReviews]) => {
    const [artistSlug, albumId] = key.split('/')
    
    return {
      params: { artist: artistSlug, album: albumId },
      props: { albumReviews },
    }
  })
}

type Props = {
  albumReviews: CollectionEntry<'reviews'>[]
}

const { albumReviews } = Astro.props as Props
const firstReview = albumReviews[0]

const artist = await getEntry('artists', firstReview.data.artist_id)
const album = await getEntry('albums', firstReview.data.album_id)

if (!artist || !album) {
  throw new Error(`Missing artist or album data`)
}

// Sort by score (highest first)
const sortedReviews = sortByScore(albumReviews)

// Calculate stats
const totalReviews = albumReviews.length
const avgScore = calculateAverageScore(albumReviews)
---

<BaseLayout title={`${album.data.title} - ${artist.data.name}`}>
  <div class="mx-auto max-w-6xl px-4 py-12">
    <Breadcrumb items={[
      { label: 'Home', href: '/' },
      { label: artist.data.name, href: `/${firstReview.data.artist_id}` },
      { label: album.data.title }
    ]} />

    <!-- Album Header -->
    <div class="mb-12 border-b border-zinc-800 pb-8">
      <div class="mb-2 text-sm text-zinc-500">
        <a href={`/${firstReview.data.artist_id}`} class="hover:text-zinc-300 transition-colors">
          {artist.data.name}
        </a>
      </div>
      <h1 class="mb-4 text-5xl font-bold tracking-tight text-white">
        {album.data.title}
      </h1>
      <div class="flex flex-wrap gap-6 text-lg text-zinc-400">
        {album.data.year && (
          <div>
            <span class="text-zinc-500">Year:</span>
            <span class="ml-2 text-zinc-300">{album.data.year}</span>
          </div>
        )}
        {album.data.genre && album.data.genre.length > 0 && (
          <div>
            <span class="text-zinc-500">Genre:</span>
            <span class="ml-2 text-zinc-300">{album.data.genre.join(', ')}</span>
          </div>
        )}
      </div>
      <div class="mt-4 flex gap-6 text-sm text-zinc-400">
        <div>
          <span class="text-2xl font-bold text-white">{totalReviews}</span>
          <span class="ml-2">reviews</span>
        </div>
        <div>
          <span class="text-2xl font-bold text-white">{avgScore}</span>
          <span class="ml-2">avg score</span>
        </div>
      </div>
    </div>

    <!-- Reviews List -->
    <div class="space-y-2">
      <h2 class="mb-6 text-2xl font-bold text-white">Tracks</h2>
      
      {sortedReviews.map((review) => {
        const { artist: artistSlug, song: songSlug } = getReviewSlugs(review.id)
        
        return (
          <ReviewListItem
            song={review.data.song}
            score={review.data.final_score}
            href={`/${artistSlug}/${songSlug}`}
          />
        )
      })}
    </div>
  </div>
</BaseLayout>
