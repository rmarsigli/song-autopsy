---
import { getCollection, getEntry, type CollectionEntry } from 'astro:content'
import BaseLayout from '../../layouts/base-layout.astro'
import Breadcrumb from '../../components/breadcrumb.astro'
import ReviewListItem from '../../components/review-list-item.astro'
import ExaminerCard from '../../components/examiner-card.astro'
import { getClassification, getScoreColor } from '../../utils/classification'
import { sortByDate, getReviewSlugs } from '../../utils/review-helpers'

import IconTrophy from '~icons/mdi/trophy'
import IconHeartPulse from '~icons/mdi/heart-pulse'
import IconBrain from '~icons/mdi/brain'
import IconFileDocument from '~icons/mdi/file-document-outline'
import IconFormatText from '~icons/mdi/format-text'
import IconImageMultiple from '~icons/mdi/image-multiple'
import IconLightbulb from '~icons/mdi/lightbulb-on'
import IconCheckCircle from '~icons/mdi/check-circle'
import IconAlertCircle from '~icons/mdi/alert-circle'
import IconBookmark from '~icons/mdi/bookmark-check'
import IconMusic from '~icons/mdi/music-note'
import IconAlbum from '~icons/mdi/album'
import IconArtist from '~icons/mdi/account-music'
import IconPlaylist from '~icons/mdi/playlist-music'

export async function getStaticPaths() {
  const reviews = await getCollection('reviews')
  
  return reviews.map((review) => {
    const [artist, song] = review.id.split('/')
    
    return {
      params: { artist, song: song.replace(/\.md$/, '') },
      props: { review },
    }
  })
}

type Props = {
  review: CollectionEntry<'reviews'>
}

const { review } = Astro.props as Props
const { Content } = await review.render()

const artist = await getEntry('artists', review.data.artist_id)
const album = review.data.album_id ? await getEntry('albums', review.data.album_id) : null

if (!artist) {
  throw new Error(`Missing artist data for review: ${review.id}`)
}

const classification = getClassification(review.data.final_score)
const scoreColor = getScoreColor(review.data.final_score)

// Get other reviews from the same artist
const allReviews = await getCollection('reviews')
const artistReviewsAll = allReviews.filter(r => r.data.artist_id === review.data.artist_id && r.id !== review.id)
const artistReviews = sortByDate(artistReviewsAll).slice(0, 10)

// Get albums for display
const albums = await getCollection('albums')
const albumMap = Object.fromEntries(
  albums.map(album => [album.id, album.data.title])
)

// Prepare texts array for display
const dimensions = [
  { key: 'emotional_impact', label: 'Emotional Impact', score: review.data.scores.emotional_impact, icon: IconHeartPulse },
  { key: 'thematic_depth', label: 'Thematic Depth', score: review.data.scores.thematic_depth, icon: IconBrain },
  { key: 'narrative_structure', label: 'Narrative Structure', score: review.data.scores.narrative_structure, icon: IconFileDocument },
  { key: 'linguistic_technique', label: 'Linguistic Technique', score: review.data.scores.linguistic_technique, icon: IconFormatText },
  { key: 'imagery', label: 'Imagery', score: review.data.scores.imagery, icon: IconImageMultiple },
  { key: 'originality', label: 'Originality', score: review.data.scores.originality, icon: IconLightbulb },
] as const

// Build breadcrumb with album if available
const breadcrumbItems: Array<{ label: string; href?: string }> = [
  { label: 'Home', href: '/' },
  { label: artist.data.name, href: `/${review.data.artist_id}` },
]

if (album) {
  breadcrumbItems.push({ 
    label: album.data.title, 
    href: `/${review.data.artist_id}/${review.data.album_id}` 
  })
}

breadcrumbItems.push({ label: review.data.song })

// Schema.org Review
const reviewSchema = {
  '@context': 'https://schema.org',
  '@type': 'Review',
  itemReviewed: {
    '@type': 'MusicRecording',
    name: review.data.song,
    byArtist: {
      '@type': 'MusicGroup',
      name: artist.data.name,
      ...(artist.data.genre && { genre: artist.data.genre }),
    },
    ...(album && {
      inAlbum: {
        '@type': 'MusicAlbum',
        name: album.data.title,
      }
    }),
  },
  reviewRating: {
    '@type': 'Rating',
    ratingValue: review.data.final_score,
    bestRating: 10,
    worstRating: 0,
  },
  author: {
    '@type': 'Organization',
    name: 'Song Autopsy',
  },
  datePublished: review.data.analyzed_at,
  reviewBody: review.data.texts.emotional_impact,
}

const description = `${classification} (${review.data.final_score}/10). ${review.data.texts.emotional_impact.substring(0, 150)}...`
const ogImage = `/${review.id.replace(/\.md$/, '')}.png`
---

<BaseLayout 
  title={`${review.data.song} by ${artist.data.name} - Review and Analysis`}
  description={description}
  image={ogImage}
  type="article"
  schema={reviewSchema}
>
  <div class="mx-auto max-w-7xl px-4 py-8">
    <Breadcrumb items={breadcrumbItems} />

    <!-- Header -->
    <header class="mb-12 border-l-4 border-zinc-700 pl-6">
      <h1 class="mb-2 text-6xl font-black tracking-tight text-white">
        {review.data.song}
      </h1>
      <div class="flex items-center gap-3 text-xl text-zinc-400">
        <IconArtist class="w-5 h-5 text-zinc-500" />
        <a href={`/${review.data.artist_id}`} class="hover:text-zinc-200 transition-colors">
          {artist.data.name}
        </a>
        {album && (
          <>
            <span class="text-zinc-600">•</span>
            <IconAlbum class="w-5 h-5 text-zinc-500" />
            <span class="text-zinc-500">{album.data.title}</span>
          </>
        )}
      </div>
    </header>

    <!-- Main Grid: Score | Content | Meta -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-8 mb-16">
      
      <!-- Left Sidebar: Score -->
      <aside class="md:col-span-1 space-y-6">
        <div class="sticky top-8">
          <div class="bg-gradient-to-br from-zinc-900 to-zinc-800 border-2 border-zinc-700 rounded-xl p-6 text-center">
            <div class="mb-3 flex items-center justify-center gap-2 text-sm font-semibold uppercase tracking-widest text-zinc-500">
              <IconTrophy class="w-4 h-4" />
              <span>Final Score</span>
            </div>
            <div class={`text-7xl font-black ${scoreColor}`}>
              {review.data.final_score}
            </div>
            <div class="mt-2 text-sm font-medium text-zinc-400">
              {classification}
            </div>
          </div>

          <!-- Dimension Scores -->
          <div class="mt-6 space-y-2">
            {dimensions.map(dim => (
              <div class="flex items-center gap-2 bg-zinc-900/50 border border-zinc-800 rounded px-3 py-2 text-sm">
                <dim.icon class="w-4 h-4 text-zinc-500 shrink-0" />
                <span class="text-zinc-400 truncate flex-1">{dim.label}</span>
                <span class="font-bold text-zinc-200">{dim.score}</span>
              </div>
            ))}
          </div>
        </div>
      </aside>

      <!-- Center: Main Content -->
      <article class="md:col-span-2 prose prose-invert prose-zinc max-w-none
        prose-headings:font-bold prose-headings:tracking-tight
        prose-h1:text-4xl prose-h1:mb-6 prose-h1:text-white
        prose-h2:text-2xl prose-h2:mt-10 prose-h2:mb-4 prose-h2:border-b prose-h2:border-zinc-800 prose-h2:pb-2 prose-h2:text-zinc-100
        prose-h3:text-xl prose-h3:mt-6 prose-h3:mb-3 prose-h3:text-zinc-200
        prose-h4:text-lg prose-h4:mt-4 prose-h4:mb-2 prose-h4:text-zinc-300
        prose-p:text-zinc-300 prose-p:leading-relaxed prose-p:mb-4
        prose-strong:text-white prose-strong:font-semibold
        prose-em:text-zinc-400 prose-em:italic
        prose-code:text-zinc-300 prose-code:bg-zinc-900 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:text-sm
        prose-pre:bg-zinc-900 prose-pre:border prose-pre:border-zinc-800 prose-pre:rounded-lg
        prose-a:text-blue-400 prose-a:no-underline prose-a:font-medium hover:prose-a:text-blue-300 hover:prose-a:underline
        prose-ul:list-disc prose-ul:ml-6 prose-ul:text-zinc-300
        prose-ol:list-decimal prose-ol:ml-6 prose-ol:text-zinc-300
        prose-li:text-zinc-300 prose-li:mb-1
        prose-blockquote:border-l-4 prose-blockquote:border-zinc-700 prose-blockquote:pl-4 prose-blockquote:italic prose-blockquote:text-zinc-400
        prose-hr:border-zinc-800 prose-hr:my-8
      ">
        <Content />

        <!-- Examiner Card -->
        <div class="not-prose mt-12">
          <ExaminerCard 
            model={review.data.model_used}
            cynicism={review.data.cynicism_level}
          />
        </div>
      </article>

      <!-- Right Sidebar: Metadata -->
      <aside class="md:col-span-1 space-y-6">
        <div class="sticky top-8 space-y-6">
          
          {review.data.strengths && review.data.strengths.length > 0 && (
            <div class="bg-green-950/30 border border-green-900/50 rounded-lg p-4">
              <h3 class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider text-green-400 mb-3">
                <IconCheckCircle class="w-4 h-4" />
                <span>Strengths</span>
              </h3>
              <ul class="space-y-2 text-sm text-zinc-300">
                {review.data.strengths.map(item => (
                  <li class="flex gap-2">
                    <span class="text-green-500 shrink-0">+</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {review.data.weaknesses && review.data.weaknesses.length > 0 && (
            <div class="bg-red-950/30 border border-red-900/50 rounded-lg p-4">
              <h3 class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider text-red-400 mb-3">
                <IconAlertCircle class="w-4 h-4" />
                <span>Weaknesses</span>
              </h3>
              <ul class="space-y-2 text-sm text-zinc-300">
                {review.data.weaknesses.map(item => (
                  <li class="flex gap-2">
                    <span class="text-red-500 shrink-0">-</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {review.data.essential_for && review.data.essential_for.length > 0 && (
            <div class="bg-zinc-800/30 border border-zinc-700/50 rounded-lg p-4">
              <h3 class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider text-zinc-400 mb-3">
                <IconBookmark class="w-4 h-4" />
                <span>Essential For</span>
              </h3>
              <ul class="space-y-2 text-sm text-zinc-300">
                {review.data.essential_for.map(item => (
                  <li class="flex gap-2">
                    <span class="text-zinc-500 shrink-0">→</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

          {review.data.similar_to && review.data.similar_to.length > 0 && (
            <div class="bg-purple-950/30 border border-purple-900/50 rounded-lg p-4">
              <h3 class="flex items-center gap-2 text-sm font-bold uppercase tracking-wider text-purple-400 mb-3">
                <IconMusic class="w-4 h-4" />
                <span>Similar To</span>
              </h3>
              <ul class="space-y-2 text-sm text-zinc-300">
                {review.data.similar_to.map(item => (
                  <li class="flex gap-2">
                    <span class="text-purple-500 shrink-0">≈</span>
                    <span>{item}</span>
                  </li>
                ))}
              </ul>
            </div>
          )}

        </div>
      </aside>
    </div>

    <!-- Bottom Section: Detailed Analysis -->
    <section class="border-t border-zinc-800 pt-12 pb-12">
      <h2 class="mb-8 text-3xl font-bold text-white">
        Detailed Analysis
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {dimensions.map(dim => {
          const text = review.data.texts[dim.key]
          if (!text) return null
          
          return (
            <div class="bg-zinc-900/50 border border-zinc-800 rounded-lg p-6 hover:border-zinc-700 transition-colors">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-white">
                  {dim.label}
                </h3>
                <span class={`text-2xl font-bold ${
                  dim.score >= 8 ? 'text-green-500' :
                  dim.score >= 6 ? 'text-yellow-500' :
                  'text-red-500'
                }`}>
                  {dim.score}
                </span>
              </div>
              <p class="text-sm leading-relaxed text-zinc-300">
                {text}
              </p>
            </div>
          )
        })}
      </div>
    </section>

    <!-- More from Artist -->
    {artistReviews.length > 0 && (
      <section class="border-t border-zinc-800 pt-12">
        <div class="mx-auto max-w-2xl">
          <h2 class="flex items-center gap-3 mb-6 text-2xl font-bold text-white">
            <IconPlaylist class="w-6 h-6 text-zinc-500" />
            <span>More from {artist.data.name}</span>
          </h2>
          
          <div class="space-y-2">
            {artistReviews.map((r) => {
              const { artist: artistSlug, song: songSlug } = getReviewSlugs(r.id)
              const albumTitle = r.data.album_id ? albumMap[r.data.album_id] || r.data.album_id : undefined
              
              return (
                <ReviewListItem
                  song={r.data.song}
                  album={albumTitle}
                  score={r.data.final_score}
                  href={`/${artistSlug}/${songSlug}`}
                  compact
                />
              )
            })}
          </div>
        </div>
      </section>
    )}

  </div>
</BaseLayout>